# SAI PTF

| Title       | SAI PTF         |
| ----------- | --------------- |
| Authors     | Intel           |
| Status      | In review       |
| Type        | Standards track |
| Created     | 07/10/2021      |
| SAI-Version | 1.9             |

## Overview

SAI PTF (Packet Testing Framework) is an autogenerated Python based dataplane testing framework. It is using thrift features to call C-based SAI functions in Python scripts. The main goal of the framework is to reduce the time spent on writing wrapper functions for SAI which could be generated based on SAI headers.

Apart from the framework there's a set of tests separated in per-feature files that are using SAI PTF to verify correctness of SAI layer implemented on top of any switch.

## Autogeneration

Autogeneration part, written in Perl, is using SAI headers to create necessary code to test SAI functionality.

The files that are created during autogeneration are:

- **sai.thrift** - containing thrift interface definitions
- **sai_rpc_server.cpp** - a set of functions called via thrift from sai_adapter, which later calls SAI functions
- **sai_adapter.py** - python wrappers for calling SAI functions

These files should be generated once, per every SAI version that needs to be tested.

| Input files                                                  | Output files                                                 |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| **Templates** <br /> - *sai.thrift.tt* <br /><br />**SAI headers** <br /> - *SAI meta* generates XML files with *Doxygen* | **sai.thrit** <br /> - thrift RPC "header" <br /> - generated from scratch <br /> - needed by thrift to generate *sai_rcp_server.skeleton.cpp* <br /> - skeleton is used to generate *sai_rpc_server.cpp.tt* template |
| **Templates** <br /> - *sai_rpc_server_functions.tt* <br /> - *sai_rpc_server_helper_functions.tt* <br /><br />**Auto-generated templates** <br /> - *sai_rpc_server.cpp.tt* (by Thrift from *sai.thift*) <br /><br />**SAI headers** <br /> - *SAI meta* generates XML files with *Doxygen* | **sai_rpc_server.cpp** <br /> - thrift server <br /> - need *sai.thrift* and *Thrift* itself for generation |
| **Templates** <br /> - *sai_adapter.py.tt* <br /> - *sai_adapter_utils.tt* <br /><br />**SAI headers** <br /> - *SAI meta* generates XML files with *Doxygen* | **sai_adapter.py** <br /> - thrift client and main SAI PTF test library <br /> - generated from scratch |


All of this can be generated with gensairpc.pl script.

Autogeneration:

```
cd <root>/sai/
./gensairpc.pl --clean
```

When upgrading SAI:

```
cd SAI/meta
make
cp saimetadata.c <root>/sai
cp saimetadata.h <root>/sai
cd <root>/sai
./gensairpc.pl --clean --no-meta-build
make clean - C SAI/meta
```

Use --no-meta-build because SAI meta are already built with make.

## Test execution

Test files written in Python call functions from sai_adapter.py. When running such test auto-generated Python functions are talking with C-based RPC server to run C functions. These functions are used to create/remove SAI object and get/set their attributes. Then it is running internal SAI implementation adopting common SAI interface to test the implementation.

Tests use SAI to configure underlay switch. Using PTF we send and verify packets that are testing each switch configuration.

## Tests structure

The tests themselves are based on python unittest framework (https://docs.python.org/3/library/unittest.html). They consist of three main functions:

- setUp() - creating necessary     objects
- runTest() - running proper test
- tearDown() - removing all     created objects

Tests have to inherit from one of two base classes - SaiHelper or SaiHelperBase. SaiHelperBase is the base class that runs initial configuration for all tests. SaiHelper inherits from SaiHelperBase but provides additional configuration.

The based configuration created by SaiHelper looks like this:

| Name       | Vlan ID | Ports | Tagging |
| ----------- | ------------ | ------------ | ------------ |
| vlan10    | 10  | port0 <br />port1 <br />lag1| untagged <br />tagged <br />untagged |
| vlan20    | 20  | port2 <br />port3 <br />lag2| untagged <br />tagged <br />tagged |
| lag1   | --  | port4 <br />port5 <br />port6| -- |
| lag2   | --  | port7 <br />port8 <br />port9| -- |
| port10_rif   | --  | port10 | -- |
| port11_rif   | --  | port11 | -- |
| port12_rif   | --  | port12 | -- |
| port13_rif   | --  | port13 | -- |
| lag3 <br />lag3_rif   | --  | port14 <br />port15 <br />port16| -- |
| lag4 <br />lag4_rif   | --  | port17 <br />port18 <br />port19| -- |
| vlan30 <br />vlan30_rif    | 30  | port20 <br />port21 <br />lag5| untagged <br />tagged <br />tagged |
| lag5   | --  | port22 <br />port23 | -- |
| Additional ports   | --  | port24 <br />port25 <br />port26<br />port27<br />port28<br />port29<br />port30<br />port31| -- |

Ports 24-31 can be used by every test to create additional objects.

Both SaiHelper and SaiHelperBase classes are created in sai_base_test.py file.

If tests intend to have more cmplicated setUp then the one that is created in the base class they need to imlpement setUp method but remember to call the setUp from the base class first.

## Implemented tests

Tests are divided into per-feature files such as saivlan.py, saifdb.py etc. Framework contains tests for following features:

- acl
- bridgeport
- buffer
- debug counter
- dtel
- fdb
- hash
- hostif
- lag
- mirror
- mpls
- nat
- neighbor
- nexthop
- nexthop group
- policer
- port
- qosmap
- queue
- rif
- route
- scheduler
- schedulergroup
- srv6
- switch
- vlan
- vrf
- wred

Additionally saitest.py file contains basic test to verify if framework is working correctly.
